# フローライン（FlowLine）仕様書

> 最終更新: 2026-02-18

## 1. 概要

画面全幅を横断するグラデーションライン。装飾（ヘッダーとコンテンツの境界線）とローディングインジケーターの2つの役割を1つの要素で担う。

**一言で**: 区切り線 + YouTube 風ローディングバー = FlowLine。

---

## 2. 設計思想

### なぜ1つの要素か

初期実装ではサイドバーとページヘッダーにそれぞれ静的ラインを配置していた。ローディング機能を追加する際、2つの DOM 要素を協調させるアプローチ（Context + background-size: 100vw + セグメント計算）を試みたが、根本的にハックだった。

**YouTube の教訓**: ローディングバーは1つの要素を1箇所に置く。`position: fixed` で DOM 構造に依存しない。

### 設計判断

| 判断 | 理由 |
|------|------|
| `position: fixed` | サイドバーとメインは別の DOM ツリー。fixed なら両方にまたがれる |
| `top: 3.25rem` (52px) | ヘッダー高 = `py-3`(1.5rem) + `text-lg` line-height(1.75rem) = 3.25rem |
| `z-50` | ページヘッダー(z-40)の上、ドロップダウン等の下 |
| `pointer-events-none` | 2px の線がクリックを吸収しないように |
| 装飾ラインを廃止 | 1つの要素が装飾とローディングの両方を担う。重複排除 |

### 前提条件

- ヘッダーの高さは固定（3.25rem = 52px）
- サイドバーヘッダー（"Flum"）とページヘッダー（"# チャンネル名"）は同じ高さ
- チャンネル description は未使用（使う場合はヘッダー高が変わるため要対応）

---

## 3. 動作

### 静的状態（通常時）

画面全幅のグラデーションバー。ピンク → パープル → シアン。

```
[サイドバー] | [メインエリア]
[████████████████████████████████████] ← フルグラデーション
```

### ローディング状態（ナビゲーション中）

YouTube/NProgress 風に左から右へ伸びる。

```
開始:     [████░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░] 20%
進行中:   [██████████████████████░░░░░░░░░░░░░] ~65%
待機:     [████████████████████████████████░░░] ~90% (ここで停滞)
完了:     [████████████████████████████████████] 100% → 静的に戻る
```

---

## 4. ナビゲーション検知

### 開始の検知

`document.addEventListener("click", handler, true)` で capture phase でリンククリックを検知。

フィルタ条件（以下は無視）:
- 修飾キー付き（Ctrl/Meta/Shift/Alt）→ 新タブ等
- `href` が http/https で始まる → 外部リンク
- `href` が # で始まる → アンカーリンク
- `target="_blank"` または `download` 属性
- 現在と同じ pathname → 同ページ

### 完了の検知

`usePathname()` の変化を監視。pathname が変わったらローディング完了。

### セーフティ

8秒のタイムアウト。何らかの理由で pathname が変わらなくても強制的にローディングを終了。

---

## 5. プログレスアニメーション

実際のデータ読み込み進捗とは無関係（不定進捗）。心理的フィードバック用。

| フェーズ | progress | 挙動 |
|---------|----------|------|
| 開始 | 0% | `requestAnimationFrame` で次フレームに 20% へジャンプ |
| 進行 | 20% → 90% | 150ms ごとに `p + (90 - p) * 0.08` で減速しながら増加 |
| 待機 | 90% | 90% で停滞（ページ読み込み完了待ち） |
| 完了 | 100% | 150ms の transition で 100% → 250ms 後に静的状態に戻る |

`transition-[width]` で CSS トランジション。進行中は 300ms、完了時は 150ms（速くパチっと終わる）。

---

## 6. ファイル構成

```
src/components/flow-line.tsx  — FlowLine コンポーネント（全ロジック集約）
src/components/app-shell.tsx  — FlowLine を1箇所だけレンダリング
```

### 削除された要素

以下の静的ラインは FlowLine に置き換えられた:
- `src/components/sidebar.tsx` の `<div className="h-[2px] bg-gradient-to-r ...">`
- `src/app/(app)/channels/[id]/page.tsx` の同上
- `src/app/(app)/scoops/page.tsx` の同上

---

## 7. 調整ガイド

### グラデーションの色を変えたい

`flow-line.tsx` の className を編集:

```
from-neon-pink via-neon-purple to-neon-cyan
```

Tailwind のグラデーション色を変更すればOK。

### 線の位置を変えたい

`top-[3.25rem]` を変更。ヘッダーの高さに合わせる。

- ヘッダーが `py-3` + `text-lg`: `3.25rem` (52px)
- ヘッダーが `py-4` + `text-lg`: `3.75rem` (60px)

### 線の太さを変えたい

`h-[2px]` を変更（例: `h-[3px]`）。

### プログレスの速度を変えたい

`flow-line.tsx` の定数を調整:

- **初期ジャンプ**: `setProgress(20)` の `20` を変更（大きいほど速くスタート）
- **増加率**: `(90 - p) * 0.08` の `0.08` を変更（大きいほど速く進む）
- **増加間隔**: `setInterval(..., 150)` の `150` を変更（小さいほど頻繁に更新）
- **上限**: `p >= 90` の `90` を変更（100 に近いほど完了前に進む）

### ローディングを特定のナビゲーションで無効にしたい

`handleClick` のフィルタ条件を追加。例えば特定の pathname へのリンクを除外:

```typescript
if (url.pathname.startsWith("/some-instant-page")) return;
```

---

## 8. 既知の制約・将来の検討事項

- **ヘッダー高の前提**: `top: 3.25rem` はヘッダーが `py-3 + text-lg` の場合の値。ヘッダーのパディングやフォントサイズを変更した場合は合わせて調整が必要
- **チャンネル description**: 現在未使用。使用する場合、ページヘッダーの高さが変わり FlowLine の位置がズレる。対応方法: description をヘッダー外に出す or 1行 truncate で高さ固定
- **form 送信のナビゲーション**: チャンネル作成等の form action による遷移は検知しない（リンククリックのみ検知）。現状は問題なし
- **同一 pathname の search params 変化**: `/scoops?channel=X` のようなフィルタ変更は pathname が同じなのでローディング開始するが完了検知できない（pathname が変わらない）。現在 Scoops のフィルタは `<a>` タグで full reload なので実質問題なし
- **`100vw` とスクロールバー**: Windows でスクロールバーが表示される場合、`100vw` はスクロールバーを含む幅。`left-0 right-0` を使用しているので実質影響なし
